<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>아랍어 자음 · 모음 · 단어 필기 연습</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #0f172a;
      color: #0f172a;
    }

    .app {
      max-width: 1400px;
      margin: 0 auto;
      min-height: 100vh;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 16px 24px 12px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(135deg, #0f172a, #111827);
      color: #f9fafb;
    }

    header h1 {
      font-size: 20px;
      margin: 0 0 4px;
      font-weight: 700;
    }

    header p {
      margin: 0;
      font-size: 13px;
      opacity: 0.85;
    }

    main {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 0;
      padding: 0;
      height: calc(100vh - 64px);
      max-height: 1000px;
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: 1fr;
        height: auto;
      }
    }

    /* 왼쪽 패널 */

    .left-panel {
      border-right: 1px solid #e5e7eb;
      background: #f3f4f6;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .tab-row {
      display: flex;
      gap: 8px;
      padding: 10px 12px 8px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .tab-btn {
      flex: 1;
      padding: 8px 0;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      background: #e5e7eb;
      color: #374151;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.15s, color 0.15s, transform 0.05s;
    }

    .tab-btn.active {
      background: #111827;
      color: #f9fafb;
    }

    .tab-btn:active {
      transform: translateY(1px);
    }

    .category-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 8px 10px 4px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .category-btn {
      padding: 4px 9px;
      border-radius: 999px;
      border: none;
      background: #e5e7eb;
      font-size: 11px;
      color: #374151;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      white-space: nowrap;
    }

    .category-btn.active {
      background: #111827;
      color: #f9fafb;
    }

    .add-word-panel {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 11px;
    }

    .add-word-panel label {
      font-size: 10px;
      color: #4b5563;
    }

    .add-word-inputs {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .add-word-inputs input,
    .add-word-inputs select {
      width: 100%;
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 11px;
    }

    .add-word-row {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .add-word-btn {
      padding: 5px 8px;
      border-radius: 8px;
      border: none;
      font-size: 11px;
      background: #111827;
      color: #f9fafb;
      cursor: pointer;
      white-space: nowrap;
    }

    .add-word-hint {
      margin-top: 2px;
      font-size: 10px;
      color: #6b7280;
    }

    .list-panel {
      flex: 1;
      overflow: auto;
      padding: 8px 10px 10px;
    }

    .letter-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }

    .letter-card {
      background: #f9fafb;
      border-radius: 10px;
      padding: 6px 4px 4px;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, border-color 0.15s, transform 0.1s;
      text-align: center;
      min-height: 64px;
      overflow: visible;
    }

    .letter-card:hover {
      background: #e5e7eb;
    }

    .letter-card.active {
      border-color: #111827;
      background: #e5e7eb;
    }

    .letter-card.word-card {
      min-height: 110px;
      padding: 10px 6px 8px;
    }

    .letter-symbol {
      font-size: 24px;
      margin-bottom: 2px;
      font-family: "Noto Naskh Arabic", "Scheherazade New", "Amiri",
        "Times New Roman", serif;
      direction: rtl;
      white-space: nowrap;
      line-height: 1.4;
    }

    .letter-card.word-card .letter-symbol {
      font-size: 20px;
      white-space: normal;
      line-height: 1.6;
      word-break: break-word;
      text-align: center;
    }

    .letter-card.word-card.long-word .letter-symbol {
      font-size: 18px;
    }

    .letter-card.word-card.very-long-word .letter-symbol {
      font-size: 16px;
    }

    .letter-name {
      font-size: 11px;
      color: #4b5563;
      margin-bottom: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .letter-extra {
      font-size: 10px;
      color: #9ca3af;
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 오른쪽 패널 */

    .right-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .info-row {
      padding: 10px 18px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      background: #f9fafb;
    }

    .info-text {
      min-width: 0;
    }

    .info-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .info-sub {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 4px;
    }

    .info-meta {
      font-size: 11px;
      color: #6b7280;
    }

    .info-roman {
      font-size: 11px;
      color: #6b7280;
      margin-left: 6px;
    }

    .info-arabic-big {
      font-family: "Noto Naskh Arabic", "Scheherazade New", "Amiri",
        "Times New Roman", serif;
      font-size: 32px;
      direction: rtl;
    }

    .info-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }

    .play-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #f9fafb;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .play-btn span {
      font-size: 13px;
    }

    .canvas-row {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      border-top: 1px solid #e5e7eb;
    }

    @media (max-width: 960px) {
      .canvas-row {
        grid-template-columns: 1fr;
        height: 640px;
      }
    }

    .canvas-panel {
      display: flex;
      flex-direction: column;
      border-left: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .canvas-panel:first-child {
      border-left: none;
    }

    .canvas-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px 6px;
      font-size: 12px;
      border-bottom: 1px solid #e5e7eb;
    }

    .canvas-header-title {
      font-weight: 600;
    }

    .canvas-tools {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #6b7280;
    }

    .slider {
      width: 80px;
    }

    .small-btn {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 11px;
      cursor: pointer;
    }

    .canvas-wrapper {
      flex: 1;
      padding: 8px 14px 12px;
    }

    canvas {
      width: 100%;
      height: 100%;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 0 0 1px #e5e7eb inset;
      touch-action: none;
    }

    .canvas-footer {
      font-size: 11px;
      color: #6b7280;
      padding: 0 14px 10px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>아랍어 자음 · 모음 · 단어 필기 연습</h1>
      <p>글자와 단어를 선택하고, 위 칸에서 따라 쓰고 아래 칸에서 직접 써 보세요.</p>
    </header>

    <main>
      <!-- 왼쪽 패널 -->
      <section class="left-panel">
        <div class="tab-row">
          <button class="tab-btn active" data-tab="letters">자음</button>
          <button class="tab-btn" data-tab="vowels">모음</button>
          <button class="tab-btn" data-tab="words">단어</button>
        </div>

        <!-- 단어 카테고리 영역 (단어 탭에서만 보이도록 JS에서 제어) -->
        <div class="category-row" id="wordCategoryRow" style="display: none;">
          <button class="category-btn active" data-category="all">전체</button>
          <button class="category-btn" data-category="color">색깔</button>
          <button class="category-btn" data-category="weather">날씨</button>
          <button class="category-btn" data-category="fruit">과일</button>
          <button class="category-btn" data-category="vegetable">야채</button>
          <button class="category-btn" data-category="transport">교통수단</button>
          <button class="category-btn" data-category="animal">동물</button>
          <button class="category-btn" data-category="family">가족</button>
          <button class="category-btn" data-category="custom">내 단어</button>
        </div>

        <!-- 단어 직접 추가 -->
        <div class="add-word-panel" id="addWordPanel" style="display: none;">
          <div><strong>단어 직접 추가</strong> <span style="color:#9ca3af;">(내 단어 카테고리)</span></div>
          <div class="add-word-inputs">
            <div>
              <label>아랍어 단어 (모음 포함)</label>
              <input id="customArabicInput" placeholder="예: كِتَابٌ" dir="rtl" />
            </div>
            <div>
              <label>뜻 (한국어)</label>
              <input id="customKoreanInput" placeholder="예: 책" />
            </div>
          </div>
          <div class="add-word-row">
            <button class="add-word-btn" id="addWordBtn">추가</button>
            <div class="add-word-hint">
              추가한 단어는 왼쪽 리스트의 <strong>내 단어</strong> 카테고리에 저장돼요.
            </div>
          </div>
        </div>

        <!-- 글자 / 단어 목록 -->
        <div class="list-panel">
          <div class="letter-grid" id="letterGrid"></div>
        </div>
      </section>

      <!-- 오른쪽 패널 -->
      <section class="right-panel">
        <div class="info-row">
          <div class="info-text">
            <div class="info-title" id="infoTitle">글자를 선택해 주세요.</div>
            <div class="info-sub" id="infoSub">
              왼쪽에서 자음, 모음 또는 단어를 누르면 정보가 여기 나옵니다.
            </div>
            <div class="info-meta" id="infoMeta"></div>
          </div>
          <div class="info-controls">
            <div class="pill">
              <span id="infoKind">타입: -</span>
            </div>
            <button class="play-btn" id="playBtn" disabled>
              <span>▶</span> 발음 듣기
            </button>
            <div class="info-arabic-big" id="infoArabicBig">ـ</div>
          </div>
        </div>

        <div class="canvas-row">
          <!-- 따라 쓰기 -->
          <div class="canvas-panel">
            <div class="canvas-header">
              <div class="canvas-header-title">1. 따라 쓰기</div>
              <div class="canvas-tools">
                선 두께
                <input type="range" min="1" max="16" value="6" class="slider" id="traceThickness" />
                <button class="small-btn" id="traceClearBtn">지우기</button>
              </div>
            </div>
            <div class="canvas-wrapper">
              <canvas id="traceCanvas"></canvas>
            </div>
            <div class="canvas-footer">
              흐릿한 글자를 보면서 모양을 따라 그려 보세요. (마우스 또는 손가락)
            </div>
          </div>

          <!-- 직접 써 보기 -->
          <div class="canvas-panel">
            <div class="canvas-header">
              <div class="canvas-header-title">2. 직접 써 보기</div>
              <div class="canvas-tools">
                선 두께
                <input type="range" min="1" max="16" value="6" class="slider" id="freeThickness" />
                <button class="small-btn" id="freeClearBtn">지우기</button>
              </div>
            </div>
            <div class="canvas-wrapper">
              <canvas id="freeCanvas"></canvas>
            </div>
            <div class="canvas-footer">
              빈 칸에 기억나는 대로 자유롭게 연습해 보세요.
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== 데이터 정의 =====

    const letters = [
      { letter: "ا", name: "alif (اَلِف)", roman: "a / ʾa", kind: "자음", desc: "모음 역할도 하는 자음" },
      { letter: "ب", name: "bā’ (بَاء)", roman: "b", kind: "자음", desc: "입술 소리, 한국어 ㅂ과 비슷" },
      { letter: "ت", name: "tā’ (تَاء)", roman: "t", kind: "자음", desc: "무성 치음, 한국어 ㅌ 사이" },
      { letter: "ث", name: "thā’ (ثَاء)", roman: "th", kind: "자음", desc: "영어 thank 의 th" },
      { letter: "ج", name: "jīm (جِيم)", roman: "j", kind: "자음", desc: "지역에 따라 [j]/[g]" },
      { letter: "ح", name: "ḥā’ (حَاء)", roman: "ḥ", kind: "자음", desc: "목에서 나는 강한 h" },
      { letter: "خ", name: "khā’ (خَاء)", roman: "kh", kind: "자음", desc: "목 가래 긁는 소리" },
      { letter: "د", name: "dāl (دَال)", roman: "d", kind: "자음", desc: "한국어 ㄷ과 비슷" },
      { letter: "ذ", name: "dhāl (ذَال)", roman: "dh", kind: "자음", desc: "영어 this 의 th" },
      { letter: "ر", name: "rā’ (رَاء)", roman: "r", kind: "자음", desc: "가볍게 혀를 떠는 r" },
      { letter: "ز", name: "zāy (زَاي)", roman: "z", kind: "자음", desc: "영어 z" },
      { letter: "س", name: "sīn (سِين)", roman: "s", kind: "자음", desc: "한국어 ㅅ" },
      { letter: "ش", name: "shīn (شِين)", roman: "sh", kind: "자음", desc: "영어 sh" },
      { letter: "ص", name: "ṣād (صَاد)", roman: "ṣ", kind: "자음", desc: "강한 s (굵게)" },
      { letter: "ض", name: "ḍād (ضَاد)", roman: "ḍ", kind: "자음", desc: "아랍어 특유의 강한 d" },
      { letter: "ط", name: "ṭā’ (طَاء)", roman: "ṭ", kind: "자음", desc: "강한 t" },
      { letter: "ظ", name: "ẓā’ (ظَاء)", roman: "ẓ", kind: "자음", desc: "강한 dh" },
      { letter: "ع", name: "ʿayn (عَيْن)", roman: "ʿ", kind: "자음", desc: "목 깊은 곳에서 나는 소리" },
      { letter: "غ", name: "ghayn (غَيْن)", roman: "gh", kind: "자음", desc: "프랑스어 r 비슷" },
      { letter: "ف", name: "fā’ (فَاء)", roman: "f", kind: "자음", desc: "입술 사이 f" },
      { letter: "ق", name: "qāf (قَاف)", roman: "q", kind: "자음", desc: "목 안쪽 k" },
      { letter: "ك", name: "kāf (كَاف)", roman: "k", kind: "자음", desc: "한국어 ㅋ" },
      { letter: "ل", name: "lām (لَام)", roman: "l", kind: "자음", desc: "한국어 ㄹ/ㄴ 사이" },
      { letter: "م", name: "mīm (مِيم)", roman: "m", kind: "자음", desc: "입 다문 m" },
      { letter: "ن", name: "nūn (نُون)", roman: "n", kind: "자음", desc: "혓바닥 n" },
      { letter: "ه", name: "hā’ (هَاء)", roman: "h", kind: "자음", desc: "가벼운 h" },
      { letter: "و", name: "wāw (وَاو)", roman: "w / ū", kind: "자음", desc: "자음 w, 모음 u" },
      { letter: "ي", name: "yā’ (يَاء)", roman: "y / ī", kind: "자음", desc: "자음 y, 모음 i" }
    ];

    const vowels = [
      { letter: "َ", name: "fatḥa (فَتْحَة)", roman: "a", kind: "단모음", desc: "짧은 a 소리 (예: بَ = ba)" },
      { letter: "ِ", name: "kasra (كَسْرَة)", roman: "i", kind: "단모음", desc: "짧은 i 소리 (예: بِ = bi)" },
      { letter: "ُ", name: "ḍamma (ضَمَّة)", roman: "u", kind: "단모음", desc: "짧은 u 소리 (예: بُ = bu)" },
      { letter: "ْ", name: "sukūn (سُكُون)", roman: "∅", kind: "정지", desc: "모음 없이 자음만 발음" },
      { letter: "ّ", name: "shadda (شَدَّة)", roman: "자음 2번", kind: "표식", desc: "자음을 한 번 더 길게" },
      { letter: "ً", name: "tanwīn fatḥ (تَنوِين فَتْح)", roman: "an", kind: "어말 모음", desc: "어말 -an 소리" },
      { letter: "ٍ", name: "tanwīn kasr (تَنوِين كَسْر)", roman: "in", kind: "어말 모음", desc: "어말 -in 소리" },
      { letter: "ٌ", name: "tanwīn ḍamm (تَنوِين ضَمّ)", roman: "un", kind: "어말 모음", desc: "어말 -un 소리" }
    ];

    const baseWords = [
      // 색깔
      { letter: "أَحْمَرُ", name: "aḥmar", korean: "빨간색", roman: "aḥmar", kind: "단어", category: "color" },
      { letter: "أَزْرَقُ", name: "ʾazraq", korean: "파란색", roman: "azraq", kind: "단어", category: "color" },
      { letter: "أَصْفَرُ", name: "ʾaṣfar", korean: "노란색", roman: "aṣfar", kind: "단어", category: "color" },
      { letter: "أَخْضَرُ", name: "ʾakhḍar", korean: "초록색", roman: "akhḍar", kind: "단어", category: "color" },
      { letter: "أَسْوَدُ", name: "ʾaswad", korean: "검은색", roman: "aswad", category: "color", kind: "단어" },
      { letter: "أَبْيَضُ", name: "ʾabyaḍ", korean: "하얀색", roman: "abyaḍ", category: "color", kind: "단어" },
      { letter: "بُنِّيٌّ", name: "bunnīyy", korean: "갈색", roman: "bunniyy", category: "color", kind: "단어" },
      { letter: "بَنَفْسَجِيٌّ", name: "banafsajiyy", korean: "보라색", roman: "banafsajiyy", category: "color", kind: "단어" },
      // 날씨
      { letter: "مَطَرٌ", name: "maṭar", korean: "비", roman: "maṭar", category: "weather", kind: "단어" },
      { letter: "ثَلْجٌ", name: "thalj", korean: "눈 (snow)", roman: "thalj", category: "weather", kind: "단어" },
      { letter: "رِيحٌ", name: "rīḥ", korean: "바람", roman: "rīḥ", category: "weather", kind: "단어" },
      { letter: "حَارٌّ", name: "ḥārr", korean: "더운 날씨", roman: "ḥārr", category: "weather", kind: "단어" },
      { letter: "بَارِدٌ", name: "bārid", korean: "추운 날씨", roman: "bārid", category: "weather", kind: "단어" },
      // 과일
      { letter: "تُفَّاحَةٌ", name: "tuffāḥa", korean: "사과", roman: "tuffāḥa", category: "fruit", kind: "단어" },
      { letter: "مَوْزَةٌ", name: "mawza", korean: "바나나", roman: "mawza", category: "fruit", kind: "단어" },
      { letter: "عِنَبٌ", name: "ʿinab", korean: "포도", roman: "ʿinab", category: "fruit", kind: "단어" },
      { letter: "بُرْتُقَالَةٌ", name: "burtuqāla", korean: "오렌지", roman: "burtuqāla", category: "fruit", kind: "단어" },
      { letter: "فَرَاوَلَةٌ", name: "farāwla", korean: "딸기", roman: "farāwla", category: "fruit", kind: "단어" },
      // 야채
      { letter: "جَزَرٌ", name: "jazar", korean: "당근", roman: "jazar", category: "vegetable", kind: "단어" },
      { letter: "بَطَاطِسُ", name: "baṭāṭis", korean: "감자", roman: "baṭāṭis", category: "vegetable", kind: "단어" },
      { letter: "طَمَاطِمُ", name: "ṭamāṭim", korean: "토마토", roman: "ṭamāṭim", category: "vegetable", kind: "단어" },
      { letter: "بَصَلٌ", name: "baṣal", korean: "양파", roman: "baṣal", category: "vegetable", kind: "단어" },
      // 교통수단
      { letter: "سَيَّارَةٌ", name: "sayyāra", korean: "자동차", roman: "sayyāra", category: "transport", kind: "단어" },
      { letter: "حَافِلَةٌ", name: "ḥāfila", korean: "버스", roman: "ḥāfila", category: "transport", kind: "단어" },
      { letter: "قِطَارٌ", name: "qiṭār", korean: "기차", roman: "qiṭār", category: "transport", kind: "단어" },
      { letter: "مِتْرُو", name: "mitrū", korean: "지하철", roman: "mitrū", category: "transport", kind: "단어" },
      { letter: "طَائِرَةٌ", name: "ṭāʾira", korean: "비행기", roman: "ṭāʾira", category: "transport", kind: "단어" },
      // 동물
      { letter: "قِطَّةٌ", name: "qiṭṭa", korean: "고양이", roman: "qiṭṭa", category: "animal", kind: "단어" },
      { letter: "كَلْبٌ", name: "kalb", korean: "개", roman: "kalb", category: "animal", kind: "단어" },
      { letter: "حِصَانٌ", name: "ḥiṣān", korean: "말", roman: "ḥiṣān", category: "animal", kind: "단어" },
      // 가족
      { letter: "أُمٌّ", name: "ʾumm", korean: "엄마", roman: "ʾumm", category: "family", kind: "단어" },
      { letter: "أَبٌ", name: "ʾab", korean: "아빠", roman: "ʾab", category: "family", kind: "단어" },
      { letter: "أَخٌ", name: "ʾakh", korean: "형/오빠/남동생", roman: "ʾakh", category: "family", kind: "단어" },
      { letter: "أُخْتٌ", name: "ʾukht", korean: "누나/언니/여동생", roman: "ʾukht", category: "family", kind: "단어" }
    ];

    const STORAGE_KEY = "arabic_practice_custom_words_v1";

    function loadCustomWords() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveCustomWords(words) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(words));
      } catch {
        // ignore
      }
    }

    let customWords = loadCustomWords();

    // ===== 상태 =====

    let currentTab = "letters"; // letters | vowels | words
    let currentCategory = "all"; // words category
    let currentData = letters;
    let currentItem = null;
    let currentSampleText = "ا";

    const letterGrid = document.getElementById("letterGrid");
    const tabButtons = document.querySelectorAll(".tab-btn");
    const wordCategoryRow = document.getElementById("wordCategoryRow");
    const addWordPanel = document.getElementById("addWordPanel");
    const categoryButtons = document.querySelectorAll(".category-btn");

    const infoTitle = document.getElementById("infoTitle");
    const infoSub = document.getElementById("infoSub");
    const infoMeta = document.getElementById("infoMeta");
    const infoKind = document.getElementById("infoKind");
    const infoArabicBig = document.getElementById("infoArabicBig");
    const playBtn = document.getElementById("playBtn");

    const customArabicInput = document.getElementById("customArabicInput");
    const customKoreanInput = document.getElementById("customKoreanInput");
    const addWordBtn = document.getElementById("addWordBtn");

    // 캔버스
    const traceCanvas = document.getElementById("traceCanvas");
    const freeCanvas = document.getElementById("freeCanvas");
    const traceThickness = document.getElementById("traceThickness");
    const freeThickness = document.getElementById("freeThickness");
    const traceClearBtn = document.getElementById("traceClearBtn");
    const freeClearBtn = document.getElementById("freeClearBtn");

    let traceCtx, freeCtx;
    let isTraceDrawing = false;
    let isFreeDrawing = false;
    let lastTracePos = null;
    let lastFreePos = null;

    // ===== 유틸 =====

    function getCurrentWords() {
      const all = baseWords.concat(customWords);
      if (currentCategory === "all") return all;
      if (currentCategory === "custom")
        return all.filter((w) => w.category === "custom");
      return all.filter((w) => w.category === currentCategory);
    }

    function renderGrid() {
      letterGrid.innerHTML = "";
      let data;
      if (currentTab === "letters") {
        currentData = letters;
      } else if (currentTab === "vowels") {
        currentData = vowels;
      } else {
        currentData = getCurrentWords();
      }
      data = currentData;

      data.forEach((item, index) => {
        const card = document.createElement("button");
        card.className = "letter-card";
        if (currentTab === "words") {
          card.classList.add("word-card");

          const length = item.letter.replace(/\s+/g, "").length;
          if (length >= 12) card.classList.add("very-long-word");
          else if (length >= 8) card.classList.add("long-word");
        }
        card.dataset.index = index;

        const symbol = document.createElement("div");
        symbol.className = "letter-symbol";
        symbol.textContent = item.letter;

        const name = document.createElement("div");
        name.className = "letter-name";
        if (currentTab === "words") {
          name.textContent = item.korean || "";
        } else {
          name.textContent = item.name || "";
        }

        const extra = document.createElement("div");
        extra.className = "letter-extra";
        if (currentTab === "words") {
          let catLabel = "";
          switch (item.category) {
            case "color":
              catLabel = "색깔";
              break;
            case "weather":
              catLabel = "날씨";
              break;
            case "fruit":
              catLabel = "과일";
              break;
            case "vegetable":
              catLabel = "야채";
              break;
            case "transport":
              catLabel = "교통";
              break;
            case "animal":
              catLabel = "동물";
              break;
            case "family":
              catLabel = "가족";
              break;
            case "custom":
              catLabel = "내 단어";
              break;
          }
          extra.textContent = (item.roman || "") + (catLabel ? " · " + catLabel : "");
        } else {
          extra.textContent = item.roman || "";
        }

        card.appendChild(symbol);
        card.appendChild(name);
        card.appendChild(extra);

        card.addEventListener("click", () => {
          document
            .querySelectorAll(".letter-card")
            .forEach((c) => c.classList.remove("active"));
          card.classList.add("active");
          currentItem = item;
          updateInfo();
          updateSampleText();
        });

        letterGrid.appendChild(card);
      });
    }

    function updateInfo() {
      if (!currentItem) {
        infoTitle.textContent = "글자를 선택해 주세요.";
        infoSub.textContent = "왼쪽에서 자음, 모음 또는 단어를 누르면 정보가 여기 나옵니다.";
        infoMeta.textContent = "";
        infoKind.textContent = "타입: -";
        infoArabicBig.textContent = "ـ";
        playBtn.disabled = true;
        return;
      }

      if (currentTab === "words") {
        infoTitle.textContent = `${currentItem.letter} (${currentItem.korean})`;
        infoSub.textContent = `로마자: ${currentItem.name || ""} (${currentItem.roman || ""})`;
        infoMeta.textContent = `카테고리: ${currentItem.category === "custom" ? "내 단어" : currentItem.category}`;
        infoKind.textContent = "타입: 단어";
      } else if (currentTab === "letters") {
        infoTitle.textContent = currentItem.name || "";
        infoSub.textContent = `발음: ${currentItem.roman || ""}`;
        infoMeta.textContent = currentItem.desc || "";
        infoKind.textContent = "타입: 자음";
      } else {
        infoTitle.textContent = currentItem.name || "";
        infoSub.textContent = `기본 소리: ${currentItem.roman || ""}`;
        infoMeta.textContent = currentItem.desc || "";
        infoKind.textContent = "타입: 모음";
      }

      infoArabicBig.textContent = currentItem.letter;
      playBtn.disabled = false;
    }

    function updateSampleText() {
      if (!currentItem) return;
      currentSampleText = currentItem.letter;
      drawTraceSample(currentSampleText);
    }

    // ===== 탭 전환 =====

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        tabButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentTab = btn.dataset.tab;

        if (currentTab === "words") {
          wordCategoryRow.style.display = "flex";
          addWordPanel.style.display = "block";
        } else {
          wordCategoryRow.style.display = "none";
          addWordPanel.style.display = "none";
        }

        currentItem = null;
        updateInfo();
        renderGrid();
        // 새로운 데이터에서 첫 번째 아이템 자동 선택 (있다면)
        const firstCard = letterGrid.querySelector(".letter-card");
        if (firstCard) {
          firstCard.click();
        } else {
          drawTraceSample("ا");
        }
      });
    });

    categoryButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        categoryButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentCategory = btn.dataset.category;
        currentItem = null;
        renderGrid();
        const firstCard = letterGrid.querySelector(".letter-card");
        if (firstCard) firstCard.click();
      });
    });

    // ===== 단어 추가 =====

    addWordBtn.addEventListener("click", () => {
      const ar = (customArabicInput.value || "").trim();
      const ko = (customKoreanInput.value || "").trim();
      if (!ar || !ko) {
        alert("아랍어 단어와 뜻을 모두 입력해 주세요.");
        return;
      }
      const newWord = {
        letter: ar,
        name: ar,
        korean: ko,
        roman: "",
        kind: "단어",
        category: "custom"
      };
      customWords.push(newWord);
      saveCustomWords(customWords);
      customArabicInput.value = "";
      customKoreanInput.value = "";
      if (currentTab === "words") {
        renderGrid();
      }
    });

    // ===== 발음 (Web Speech API) =====

    function speakArabic(text) {
      if (!("speechSynthesis" in window)) {
        alert("이 브라우저에서는 음성 재생을 지원하지 않습니다.");
        return;
      }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "ar-SA";
      utter.rate = 0.9;
      utter.pitch = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    playBtn.addEventListener("click", () => {
      if (!currentItem) return;
      speakArabic(currentItem.letter);
    });

    // ===== 캔버스 설정 =====

    function resizeCanvases() {
      [traceCanvas, freeCanvas].forEach((canvas) => {
        const rect = canvas.getBoundingClientRect();
        const ratio = window.devicePixelRatio || 1;
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        const ctx = canvas.getContext("2d");
        ctx.scale(ratio, ratio);
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
      });
      traceCtx = traceCanvas.getContext("2d");
      freeCtx = freeCanvas.getContext("2d");
      // 다시 샘플 그리기
      drawTraceSample(currentSampleText || "ا");
    }

    window.addEventListener("resize", () => {
      resizeCanvases();
    });

    function clearCanvas(ctx, canvas) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    traceClearBtn.addEventListener("click", () => {
      clearCanvas(traceCtx, traceCanvas);
      drawTraceSample(currentSampleText || "ا");
    });

    freeClearBtn.addEventListener("click", () => {
      clearCanvas(freeCtx, freeCanvas);
    });

    // 좌표 계산
    function getCanvasPos(canvas, evt) {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      if (evt.touches && evt.touches.length > 0) {
        const t = evt.touches[0];
        return {
          x: (t.clientX - rect.left),
          y: (t.clientY - rect.top)
        };
      } else {
        return {
          x: (evt.clientX - rect.left),
          y: (evt.clientY - rect.top)
        };
      }
    }

    function setupDrawing(canvas, ctxRef, thicknessInput, isDrawingRef, lastPosRefSetter) {
      const isTouch = "ontouchstart" in window;

      const start = (evt) => {
        evt.preventDefault();
        const pos = getCanvasPos(canvas, evt);
        lastPosRefSetter(pos);
        ctxRef().lineWidth = Number(thicknessInput.value);
        ctxRef().strokeStyle = "#111827";
        isDrawingRef(true);
      };

      const move = (evt) => {
        if (!isDrawingRef()) return;
        evt.preventDefault();
        const pos = getCanvasPos(canvas, evt);
        const last = lastPosRefSetter();
        ctxRef().beginPath();
        ctxRef().moveTo(last.x, last.y);
        ctxRef().lineTo(pos.x, pos.y);
        ctxRef().stroke();
        lastPosRefSetter(pos);
      };

      const end = (evt) => {
        if (!isDrawingRef()) return;
        evt.preventDefault();
        isDrawingRef(false);
      };

      const opts = { passive: false };

      if (isTouch) {
        canvas.addEventListener("touchstart", start, opts);
        canvas.addEventListener("touchmove", move, opts);
        canvas.addEventListener("touchend", end, opts);
        canvas.addEventListener("touchcancel", end, opts);
      } else {
        canvas.addEventListener("mousedown", start);
        canvas.addEventListener("mousemove", move);
        window.addEventListener("mouseup", end);
      }
    }

    // 상태 래퍼 (클로저용)
    let _isTrace = false;
    let _isFree = false;
    let _lastTrace = null;
    let _lastFree = null;

    function isTrace(v) {
      if (typeof v === "boolean") _isTrace = v;
      return _isTrace;
    }
    function isFree(v) {
      if (typeof v === "boolean") _isFree = v;
      return _isFree;
    }
    function lastTracePosFunc(v) {
      if (v) _lastTrace = v;
      return _lastTrace;
    }
    function lastFreePosFunc(v) {
      if (v) _lastFree = v;
      return _lastFree;
    }

    // 따라쓰기 샘플 그리기 (자동 크기 조절)
    function drawTraceSample(text) {
      if (!traceCanvas) return;
      const canvas = traceCanvas;
      const ctx = canvas.getContext("2d");
      const rect = canvas.getBoundingClientRect();

      ctx.clearRect(0, 0, rect.width, rect.height);

      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,0.05)";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      const maxWidth = rect.width * 0.85;
      const maxHeight = rect.height * 0.7;
      let fontSize = Math.min(rect.width, rect.height); // 크게 시작

      while (fontSize > 10) {
        ctx.font =
          fontSize +
          "px 'Noto Naskh Arabic', 'Scheherazade New', 'Amiri', 'Times New Roman', serif";
        const metrics = ctx.measureText(text);
        const textWidth = metrics.width;
        const textHeight = fontSize;

        if (textWidth <= maxWidth && textHeight <= maxHeight) {
          break;
        }
        fontSize -= 4;
      }

      ctx.font =
        fontSize +
        "px 'Noto Naskh Arabic', 'Scheherazade New', 'Amiri', 'Times New Roman', serif";
      ctx.fillText(text, rect.width / 2, rect.height / 2);

      ctx.restore();
    }

    // ===== 초기화 =====

    function init() {
      renderGrid();
      const firstCard = letterGrid.querySelector(".letter-card");
      if (firstCard) firstCard.click();
      resizeCanvases();

      setupDrawing(
        traceCanvas,
        () => traceCtx,
        traceThickness,
        isTrace,
        lastTracePosFunc
      );
      setupDrawing(
        freeCanvas,
        () => freeCtx,
        freeThickness,
        isFree,
        lastFreePosFunc
      );
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
