<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Arabic Practice Lab</title>
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background-color: #f3f4f6;
      color: #111827;
    }
    body {
      display: flex;
      flex-direction: column;
    }

    /* ìƒë‹¨ í—¤ë” */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: #111827;
      color: #f9fafb;
    }
    .app-title {
      font-weight: 700;
      font-size: 1rem;
    }
    .tab-bar {
      display: flex;
      gap: 8px;
    }
    .tab-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      background: #1f2937;
      color: #e5e7eb;
      transition: background 0.15s, color 0.15s;
    }
    .tab-btn.active {
      background: #facc15;
      color: #111827;
      font-weight: 600;
    }

    /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
    .app-main {
      flex: 1;
      display: flex;
      height: calc(100vh - 52px);
      overflow: hidden;
    }
    .side-panel {
      width: 260px;
      min-width: 220px;
      max-width: 300px;
      padding: 12px;
      border-right: 1px solid #e5e7eb;
      background: #f9fafb;
      overflow-y: auto;
    }
    .side-title {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .side-sub {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .letter-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

     #wordsList.letter-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    
    .card {
      border-radius: 14px;
      padding: 6px 8px;
      background: white;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: box-shadow 0.15s, border-color 0.15s, transform 0.05s;
    }
    .card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.06);
      border-color: #d1d5db;
      transform: translateY(-1px);
    }
    .card.active {
      border-color: #f97316;
      box-shadow: 0 0 0 1px rgba(249,115,22,0.5);
    }
    .card-ar {
      font-size: 1.4rem;
      margin-bottom: 2px;
    }
    .card-name {
      font-size: 0.7rem;
      color: #374151;
    }
    .card-sound {
      font-size: 0.6rem;
      color: #6b7280;
    }

    /* ë©”ì¸ ìš°ì¸¡ ì˜ì—­ */
    .content-panel {
      flex: 1;
      padding: 12px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
    }

    /* ì„ íƒ ì •ë³´ ì¹´ë“œ */
    .selection-card {
      background: white;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      min-height: 64px;
    }
        .selection-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }
    .record-mini {
      display: flex;
      flex-direction: column;
      gap: 3px;
      align-items: flex-end;
    }
    .record-mini-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }
    .record-mini-status {
      font-size: 0.7rem;
      color: #6b7280;
      text-align: right;
    }

    .selection-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .selection-top-line {
      display: flex;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
    }
    .selection-ar {
      font-size: 1.6rem;
      direction: rtl;
      font-family: "Scheherazade New", "Noto Naskh Arabic", system-ui, sans-serif;
    }
    .selection-type {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      font-weight: 600;
    }
    .selection-extra {
      font-size: 0.75rem;
      color: #4b5563;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .selection-extra span {
      white-space: nowrap;
    }
    .selection-forms {
      font-size: 0.7rem;
      color: #6b7280;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 4px;
    }
    .selection-form-label {
      color: #9ca3af;
    }
        .selection-form-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .selection-form-btn .form-label {
      color: #9ca3af;
    }
    .selection-form-btn .form-ar {
      direction: rtl;
      font-family: "Scheherazade New", "Noto Naskh Arabic", system-ui, sans-serif;
      font-size: 1.1rem;
    }

    .play-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #111827;
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .play-btn span {
      font-size: 0.9rem;
    }
        .record-card {
      background: white;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .record-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #374151;
    }
    .record-sub {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .record-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }
    .record-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
    }
    .record-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .record-status {
      font-size: 0.75rem;
      color: #4b5563;
    }


    /* ìº”ë²„ìŠ¤ ì˜ì—­ */
    .canvas-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
    }
    .canvas-card {
      flex: 1;
      min-height: 180px;
      background: white;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow: hidden;
    }
    .canvas-header {
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .canvas-hint {
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .canvas-wrap {
      flex: 1;
      border-radius: 10px;
      border: 1px dashed #e5e7eb;
      background: #f9fafb;
      overflow: hidden;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
      touch-action: none;
    }

    .bottom-bar {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }
    .clear-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #e5e7eb;
      color: #374151;
    }

    .hidden {
      display: none !important;
    }

    /* ë°˜ì‘í˜• ì¡°ì •: ì•„ì´íŒ¨ë“œ / íƒœë¸”ë¦¿ì—ì„œ ì„¸ë¡œ ì—¬ë°± ì¤„ì´ê¸° */
    @media (max-height: 800px) {
      .canvas-card {
        min-height: 150px;
      }
    }
    @media (max-width: 900px) {
      .app-main {
        flex-direction: column;
      }
      .side-panel {
        width: 100%;
        max-width: none;
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
      }
      .letter-grid {
        grid-template-columns: repeat(6, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="app-title">Arabic Practice Lab</div>
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="letters">ììŒ</button>
      <button class="tab-btn" data-tab="vowels">ëª¨ìŒ</button>
      <button class="tab-btn" data-tab="words">ë‹¨ì–´</button>
      <button class="tab-btn" data-tab="sentences">ë¬¸ì¥</button>
    </div>
  </header>

  <main class="app-main">
    <!-- ì™¼ìª½ íŒ¨ë„ -->
    <aside class="side-panel">
      <div id="panel-letters">
        <div class="side-title">ì•„ëì–´ ììŒ</div>
        <div class="side-sub">ììŒì„ ëˆŒëŸ¬ ëª¨ì–‘ê³¼ ë°œìŒì„ ì—°ìŠµí•´ ë³´ì„¸ìš”.</div>
        <div id="lettersList" class="letter-grid"></div>
      </div>

      <div id="panel-vowels" class="hidden">
        <div class="side-title">ëª¨ìŒ ê¸°í˜¸</div>
        <div class="side-sub">ì§§ì€ ëª¨ìŒê³¼ ê¸´ ëª¨ìŒì„ ì—°ìŠµí•´ ë³´ì„¸ìš”.</div>
        <div id="vowelsList" class="letter-grid"></div>
      </div>

      <div id="panel-words" class="hidden">
        <div class="side-title">ë‹¨ì–´ ì—°ìŠµ</div>
        <div class="side-sub">ì¹´í…Œê³ ë¦¬ì—ì„œ ë‹¨ì–´ë¥¼ ì„ íƒí•´ ë³´ì„¸ìš”.</div>
        <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px;">
          <button class="tab-btn" style="padding:4px 10px; font-size:0.75rem;" data-wordcat="colors">ìƒ‰ê¹”</button>
          <button class="tab-btn" style="padding:4px 10px; font-size:0.75rem;" data-wordcat="weather">ë‚ ì”¨</button>
          <button class="tab-btn" style="padding:4px 10px; font-size:0.75rem;" data-wordcat="fruits">ê³¼ì¼</button>
          <button class="tab-btn" style="padding:4px 10px; font-size:0.75rem;" data-wordcat="transport">êµí†µìˆ˜ë‹¨</button>
        </div>
        <div id="wordsList" class="letter-grid"></div>
      </div>

      <div id="panel-sentences" class="hidden">
        <div class="side-title">ë¬¸ì¥ ì—°ìŠµ</div>
        <div class="side-sub">ê¸°ë³¸ íšŒí™” ë¬¸ì¥ì„ ê³¨ë¼ ë”°ë¼ ì¨ ë³´ì„¸ìš”.</div>
        <div id="sentencesList" style="display:flex; flex-direction:column; gap:6px;"></div>
      </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„ -->
    <section class="content-panel">
      <!-- ì„ íƒ ì •ë³´ ì¹´ë“œ -->
            <div class="selection-card" id="selectionCard">
        <div class="selection-main">
          <div class="selection-top-line">
            <div class="selection-ar" id="selArabic">ì•„ëì–´ ì—°ìŠµ ì‚¬ì´íŠ¸</div>
            <div class="selection-type" id="selType">ì•ˆë‚´</div>
          </div>
          <div class="selection-extra" id="selExtra">
            <span>ì™¼ìª½ì—ì„œ ììŒÂ·ëª¨ìŒÂ·ë‹¨ì–´Â·ë¬¸ì¥ì„ ì„ íƒí•˜ë©´ ì´ê³³ì— ì •ë³´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</span>
          </div>
          <div class="selection-forms hidden" id="selForms">
  <div class="form-title">ììŒ í˜•íƒœ ì„ íƒ</div>
  <div class="form-buttons">
    <button class="form-btn" data-form="isolated">ë‹¨ë…í˜•</button>
    <button class="form-btn" data-form="initial">ì–´ë‘í˜•</button>
    <button class="form-btn" data-form="medial">ì¤‘ê°„í˜•</button>
    <button class="form-btn" data-form="final">ì–´ë§í˜•</button>
  </div>
</div>


        </div>

        <!-- ì˜¤ë¥¸ìª½: ë°œìŒ ë“£ê¸° + ë…¹ìŒ ë²„íŠ¼ë“¤ -->
        <div class="selection-right">
          <button class="play-btn" id="playSelectionBtn">
            <span>ğŸ”Š</span> ë°œìŒ ë“£ê¸°
          </button>

          <div class="record-mini">
            <div class="record-mini-buttons">
              <button type="button" class="record-btn" id="recordStartBtn">â— ë…¹ìŒ</button>
              <button type="button" class="record-btn" id="recordStopBtn">â–  ì •ì§€</button>
              <button type="button" class="record-btn" id="recordPlayBtn">â–¶ ì¬ìƒ</button>
            </div>
            <div class="record-mini-status" id="recordStatus">ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>

      
      

      <!-- ìº”ë²„ìŠ¤ ì˜ì—­ -->
      <div class="canvas-section">
        <div class="canvas-card">
          <div class="canvas-header">
            <span>1. ë”°ë¼ ì“°ê¸°</span>
            <span class="canvas-hint">ì—°í•œ ê¸€ìë¥¼ ë”°ë¼ ê·¸ë ¤ ë³´ì„¸ìš”.</span>
          </div>
          <div class="canvas-wrap">
            <canvas id="traceCanvas"></canvas>
          </div>
        </div>

        <div class="canvas-card">
          <div class="canvas-header">
            <span>2. ì§ì ‘ ì“°ê¸°</span>
            <span class="canvas-hint">ììœ ë¡­ê²Œ ì—°ìŠµí•´ ë³´ì„¸ìš”.</span>
          </div>
          <div class="canvas-wrap">
            <canvas id="freeCanvas"></canvas>
          </div>
          <div class="bottom-bar">
            <button class="clear-btn" id="clearBtn">ëª¨ë‘ ì§€ìš°ê¸°</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ======================
    // ë°ì´í„° ì •ì˜
    // ======================
    const consonants = [
      { char: "Ø§", name: "alif", sound: "a / Ä", type: "ììŒ", forms: { isolated: "Ø§", initial: "Ø§", medial: "Ù€Ø§", final: "Ù€Ø§" } },
      { char: "Ø¨", name: "bÄÊ¼", sound: "b", type: "ììŒ", forms: { isolated: "Ø¨", initial: "Ø¨Ù€", medial: "Ù€Ø¨Ù€", final: "Ù€Ø¨" } },
      { char: "Øª", name: "tÄÊ¼", sound: "t", type: "ììŒ", forms: { isolated: "Øª", initial: "ØªÙ€", medial: "Ù€ØªÙ€", final: "Ù€Øª" } },
      { char: "Ø«", name: "thÄÊ¼", sound: "th", type: "ììŒ", forms: { isolated: "Ø«", initial: "Ø«Ù€", medial: "Ù€Ø«Ù€", final: "Ù€Ø«" } },
      { char: "Ø¬", name: "jÄ«m", sound: "j", type: "ììŒ", forms: { isolated: "Ø¬", initial: "Ø¬Ù€", medial: "Ù€Ø¬Ù€", final: "Ù€Ø¬" } },
      { char: "Ø­", name: "á¸¥ÄÊ¼", sound: "á¸¥", type: "ììŒ", forms: { isolated: "Ø­", initial: "Ø­Ù€", medial: "Ù€Ø­Ù€", final: "Ù€Ø­" } },
      { char: "Ø®", name: "khÄÊ¼", sound: "kh", type: "ììŒ", forms: { isolated: "Ø®", initial: "Ø®Ù€", medial: "Ù€Ø®Ù€", final: "Ù€Ø®" } },
      { char: "Ø¯", name: "dÄl", sound: "d", type: "ììŒ", forms: { isolated: "Ø¯", initial: "Ø¯", medial: "Ù€Ø¯", final: "Ù€Ø¯" } },
      { char: "Ø°", name: "dhÄl", sound: "dh", type: "ììŒ", forms: { isolated: "Ø°", initial: "Ø°", medial: "Ù€Ø°", final: "Ù€Ø°" } },
      { char: "Ø±", name: "rÄÊ¼", sound: "r", type: "ììŒ", forms: { isolated: "Ø±", initial: "Ø±", medial: "Ù€Ø±", final: "Ù€Ø±" } },
      { char: "Ø²", name: "zÄy", sound: "z", type: "ììŒ", forms: { isolated: "Ø²", initial: "Ø²", medial: "Ù€Ø²", final: "Ù€Ø²" } },
      { char: "Ø³", name: "sÄ«n", sound: "s", type: "ììŒ", forms: { isolated: "Ø³", initial: "Ø³Ù€", medial: "Ù€Ø³Ù€", final: "Ù€Ø³" } },
      { char: "Ø´", name: "shÄ«n", sound: "sh", type: "ììŒ", forms: { isolated: "Ø´", initial: "Ø´Ù€", medial: "Ù€Ø´Ù€", final: "Ù€Ø´" } },
      { char: "Øµ", name: "á¹£Äd", sound: "á¹£", type: "ììŒ", forms: { isolated: "Øµ", initial: "ØµÙ€", medial: "Ù€ØµÙ€", final: "Ù€Øµ" } },
      { char: "Ø¶", name: "á¸Äd", sound: "á¸", type: "ììŒ", forms: { isolated: "Ø¶", initial: "Ø¶Ù€", medial: "Ù€Ø¶Ù€", final: "Ù€Ø¶" } },
      { char: "Ø·", name: "á¹­ÄÊ¼", sound: "á¹­", type: "ììŒ", forms: { isolated: "Ø·", initial: "Ø·Ù€", medial: "Ù€Ø·Ù€", final: "Ù€Ø·" } },
      { char: "Ø¸", name: "áº“ÄÊ¼", sound: "áº“", type: "ììŒ", forms: { isolated: "Ø¸", initial: "Ø¸Ù€", medial: "Ù€Ø¸Ù€", final: "Ù€Ø¸" } },
      { char: "Ø¹", name: "Ê¿ayn", sound: "Ê¿", type: "ììŒ", forms: { isolated: "Ø¹", initial: "Ø¹Ù€", medial: "Ù€Ø¹Ù€", final: "Ù€Ø¹" } },
      { char: "Øº", name: "ghayn", sound: "gh", type: "ììŒ", forms: { isolated: "Øº", initial: "ØºÙ€", medial: "Ù€ØºÙ€", final: "Ù€Øº" } },
      { char: "Ù", name: "fÄÊ¼", sound: "f", type: "ììŒ", forms: { isolated: "Ù", initial: "ÙÙ€", medial: "Ù€ÙÙ€", final: "Ù€Ù" } },
      { char: "Ù‚", name: "qÄf", sound: "q", type: "ììŒ", forms: { isolated: "Ù‚", initial: "Ù‚Ù€", medial: "Ù€Ù‚Ù€", final: "Ù€Ù‚" } },
      { char: "Ùƒ", name: "kÄf", sound: "k", type: "ììŒ", forms: { isolated: "Ùƒ", initial: "ÙƒÙ€", medial: "Ù€ÙƒÙ€", final: "Ù€Ùƒ" } },
      { char: "Ù„", name: "lÄm", sound: "l", type: "ììŒ", forms: { isolated: "Ù„", initial: "Ù„Ù€", medial: "Ù€Ù„Ù€", final: "Ù€Ù„" } },
      { char: "Ù…", name: "mÄ«m", sound: "m", type: "ììŒ", forms: { isolated: "Ù…", initial: "Ù…Ù€", medial: "Ù€Ù…Ù€", final: "Ù€Ù…" } },
      { char: "Ù†", name: "nÅ«n", sound: "n", type: "ììŒ", forms: { isolated: "Ù†", initial: "Ù†Ù€", medial: "Ù€Ù†Ù€", final: "Ù€Ù†" } },
      { char: "Ù‡", name: "hÄÊ¼", sound: "h", type: "ììŒ", forms: { isolated: "Ù‡", initial: "Ù‡Ù€", medial: "Ù€Ù‡Ù€", final: "Ù€Ù‡" } },
      { char: "Ùˆ", name: "wÄw", sound: "w", type: "ììŒ", forms: { isolated: "Ùˆ", initial: "Ùˆ", medial: "Ù€Ùˆ", final: "Ù€Ùˆ" } },
      { char: "ÙŠ", name: "yÄÊ¼", sound: "y", type: "ììŒ", forms: { isolated: "ÙŠ", initial: "ÙŠÙ€", medial: "Ù€ÙŠÙ€", final: "Ù€ÙŠ" } },
    ];

    // ììŒ í˜•íƒœ ì •ë³´
const arabicForms = {
  "Ø§": { isolated: "Ø§", initial: "Ø§", medial: "Ù€Ø§", final: "Ù€Ø§" },
  "Ø¨": { isolated: "Ø¨", initial: "Ø¨Ù€", medial: "Ù€Ø¨Ù€", final: "Ù€Ø¨" },
  "Øª": { isolated: "Øª", initial: "ØªÙ€", medial: "Ù€ØªÙ€", final: "Ù€Øª" },
  "Ø«": { isolated: "Ø«", initial: "Ø«Ù€", medial: "Ù€Ø«Ù€", final: "Ù€Ø«" },
  "Ø¬": { isolated: "Ø¬", initial: "Ø¬Ù€", medial: "Ù€Ø¬Ù€", final: "Ù€Ø¬" },
  "Ø­": { isolated: "Ø­", initial: "Ø­Ù€", medial: "Ù€Ø­Ù€", final: "Ù€Ø­" },
  "Ø®": { isolated: "Ø®", initial: "Ø®Ù€", medial: "Ù€Ø®Ù€", final: "Ù€Ø®" },
  "Ø¯": { isolated: "Ø¯", initial: "Ø¯", medial: "Ù€Ø¯", final: "Ù€Ø¯" },
  "Ø°": { isolated: "Ø°", initial: "Ø°", medial: "Ù€Ø°", final: "Ù€Ø°" },
  "Ø±": { isolated: "Ø±", initial: "Ø±", medial: "Ù€Ø±", final: "Ù€Ø±" },
  "Ø²": { isolated: "Ø²", initial: "Ø²", medial: "Ù€Ø²", final: "Ù€Ø²" },
  "Ø³": { isolated: "Ø³", initial: "Ø³Ù€", medial: "Ù€Ø³Ù€", final: "Ù€Ø³" },
  "Ø´": { isolated: "Ø´", initial: "Ø´Ù€", medial: "Ù€Ø´Ù€", final: "Ù€Ø´" },
  "Øµ": { isolated: "Øµ", initial: "ØµÙ€", medial: "Ù€ØµÙ€", final: "Ù€Øµ" },
  "Ø¶": { isolated: "Ø¶", initial: "Ø¶Ù€", medial: "Ù€Ø¶Ù€", final: "Ù€Ø¶" },
  "Ø·": { isolated: "Ø·", initial: "Ø·Ù€", medial: "Ù€Ø·Ù€", final: "Ù€Ø·" },
  "Ø¸": { isolated: "Ø¸", initial: "Ø¸Ù€", medial: "Ù€Ø¸Ù€", final: "Ù€Ø¸" },
};


    const vowels = [
      { char: "Ù", name: "fatá¸¥a", sound: "a", type: "ëª¨ìŒ" },
      { char: "Ù", name: "kasra", sound: "i", type: "ëª¨ìŒ" },
      { char: "Ù", name: "á¸amma", sound: "u", type: "ëª¨ìŒ" },
      { char: "Ù‹", name: "tanwÄ«n fatá¸¥", sound: "an", type: "ëª¨ìŒ" },
      { char: "Ù", name: "tanwÄ«n kasr", sound: "in", type: "ëª¨ìŒ" },
      { char: "ÙŒ", name: "tanwÄ«n á¸amm", sound: "un", type: "ëª¨ìŒ" }
    ];

    const wordCategories = {
      colors: [
        { arabic: "Ø£ÙØ­Ù’Ù…ÙØ±Ù", pron: "aá¸¥mar", meaning: "ë¹¨ê°„ìƒ‰" },
        { arabic: "Ø£ÙØ²Ù’Ø±ÙÙ‚Ù", pron: "azraq", meaning: "íŒŒë€ìƒ‰" },
        { arabic: "Ø£ÙØ®Ù’Ø¶ÙØ±Ù", pron: "akhá¸ar", meaning: "ì´ˆë¡ìƒ‰" },
        { arabic: "Ø£ÙØµÙ’ÙÙØ±Ù", pron: "aá¹£far", meaning: "ë…¸ë€ìƒ‰" },
        { arabic: "Ø£ÙØ¨Ù’ÙŠÙØ¶Ù", pron: "abyaá¸", meaning: "í°ìƒ‰" },
        { arabic: "Ø£ÙØ³Ù’ÙˆÙØ¯Ù", pron: "aswad", meaning: "ê²€ì€ìƒ‰" },
        { arabic: "Ø¨ÙÙ†ÙÙ‘ÙŠÙŒÙ‘", pron: "bunniyy", meaning: "ê°ˆìƒ‰" },
        { arabic: "ÙˆÙØ±Ù’Ø¯ÙÙŠÙŒÙ‘", pron: "wardiyy", meaning: "ë¶„í™ìƒ‰" }
      ],
      weather: [
        { arabic: "Ù…ÙØ·ÙØ±ÙŒ", pron: "maá¹­ar", meaning: "ë¹„" },
        { arabic: "Ø«ÙÙ„Ù’Ø¬ÙŒ", pron: "thalj", meaning: "ëˆˆ(snow)" },
        { arabic: "Ø±ÙÙŠØ­ÙŒ", pron: "rÄ«á¸¥", meaning: "ë°”ëŒ" },
        { arabic: "Ø¬ÙÙˆÙ‘ÙŒ Ø­ÙØ§Ø±Ù‘ÙŒ", pron: "jaww á¸¥Ärr", meaning: "ë”ìš´ ë‚ ì”¨" },
        { arabic: "Ø¬ÙÙˆÙ‘ÙŒ Ø¨ÙØ§Ø±ÙØ¯ÙŒ", pron: "jaww bÄrid", meaning: "ì¶”ìš´ ë‚ ì”¨" }
      ],
      fruits: [
        { arabic: "ØªÙÙÙÙ‘Ø§Ø­ÙØ©ÙŒ", pron: "tuffÄá¸¥a", meaning: "ì‚¬ê³¼" },
        { arabic: "Ù…ÙÙˆÙ’Ø²ÙØ©ÙŒ", pron: "mawza", meaning: "ë°”ë‚˜ë‚˜" },
        { arabic: "Ø¹ÙÙ†ÙØ¨ÙŒ", pron: "Ê¿inab", meaning: "í¬ë„" },
        { arabic: "Ø¨ÙØ±Ù’ØªÙÙ‚ÙØ§Ù„ÙØ©ÙŒ", pron: "burtuqÄla", meaning: "ì˜¤ë Œì§€" }
      ],
      transport: [
        { arabic: "Ø³ÙÙŠÙÙ‘Ø§Ø±ÙØ©ÙŒ", pron: "sayyÄra", meaning: "ìë™ì°¨" },
        { arabic: "Ø­ÙØ§ÙÙÙ„ÙØ©ÙŒ", pron: "á¸¥Äfila", meaning: "ë²„ìŠ¤" },
        { arabic: "Ù‚ÙØ·ÙØ§Ø±ÙŒ", pron: "qiá¹­Är", meaning: "ê¸°ì°¨" },
        { arabic: "Ø·ÙØ§Ø¦ÙØ±ÙØ©ÙŒ", pron: "á¹­ÄÊ¾ira", meaning: "ë¹„í–‰ê¸°" }
      ]
    };

    const sentences = [
      {
        arabic: "Ø§Ù„Ø³Ù‘ÙÙ„ÙØ§Ù…Ù Ø¹ÙÙ„ÙÙŠÙ’ÙƒÙÙ…Ù’.",
        pron: "as-salÄmu Ê¿alaykum",
        meaning: "í‰ì•ˆì´ ìˆê¸°ë¥¼(ì•ˆë¶€ ì¸ì‚¬)."
      },
      {
        arabic: "ÙƒÙÙŠÙ’ÙÙ Ø­ÙØ§Ù„ÙÙƒÙØŸ",
        pron: "kayfa á¸¥Äluka?",
        meaning: "ì˜ ì§€ë‚´?"
      },
      {
        arabic: "Ø£ÙÙ†ÙØ§ Ø·ÙØ§Ù„ÙØ¨ÙØ©ÙŒ ÙÙÙŠ Ø§Ù„Ù’Ø¬ÙØ§Ù…ÙØ¹ÙØ©Ù.",
        pron: "anÄ á¹­Älibatun fÄ« al-jÄmiÊ¿a",
        meaning: "ë‚˜ëŠ” ëŒ€í•™êµ í•™ìƒì´ì•¼."
      }
    ];

    // ======================
    // ìƒíƒœ ê´€ë¦¬
    // ======================
    let currentTab = "letters";
    let currentSelection = null; // { type, arabic, meaning, pron, forms }

    // ======================
    // DOM ì°¸ì¡°
    // ======================
    const tabButtons = document.querySelectorAll(".tab-btn[data-tab]");
    const panelLetters = document.getElementById("panel-letters");
    const panelVowels = document.getElementById("panel-vowels");
    const panelWords = document.getElementById("panel-words");
    const panelSentences = document.getElementById("panel-sentences");

    const selectionCard = document.getElementById("selectionCard");
    const selArabic = document.getElementById("selArabic");
    const selType = document.getElementById("selType");
    const selExtra = document.getElementById("selExtra");
    const selForms = document.getElementById("selForms");
    const playSelectionBtn = document.getElementById("playSelectionBtn");

        const recordCard = document.getElementById("recordCard");
    const recordStartBtn = document.getElementById("recordStartBtn");
    const recordStopBtn = document.getElementById("recordStopBtn");
    const recordPlayBtn = document.getElementById("recordPlayBtn");
    const recordStatus = document.getElementById("recordStatus");


    const lettersList = document.getElementById("lettersList");
    const vowelsList = document.getElementById("vowelsList");
    const wordsList = document.getElementById("wordsList");
    const sentencesList = document.getElementById("sentencesList");

    const traceCanvas = document.getElementById("traceCanvas");
    const freeCanvas = document.getElementById("freeCanvas");
    const clearBtn = document.getElementById("clearBtn");

    let traceCtx, freeCtx;
    let traceDrawing = false;
    let freeDrawing = false;
    let traceGuideText = "";

    // ======================
    // íƒ­ ì „í™˜
    // ======================
    function setTab(tab) {
      currentTab = tab;
      tabButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });

      panelLetters.classList.toggle("hidden", tab !== "letters");
      panelVowels.classList.toggle("hidden", tab !== "vowels");
      panelWords.classList.toggle("hidden", tab !== "words");
      panelSentences.classList.toggle("hidden", tab !== "sentences");

      // ë¬¸ì¥ì´ ì•„ë‹Œ íƒ­ì—ì„œëŠ” ì„ íƒ ì •ë³´ ì¹´ë“œë§Œ ì‚¬ìš©, ì¶”ê°€ íŒ¨ë„ ì—†ìŒ
      if (!currentSelection) {
        renderSelectionInfo(null);
      }
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => setTab(btn.dataset.tab));
    });

    // ======================
    // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    // ======================
    function initLetters() {
      lettersList.innerHTML = "";
      consonants.forEach((letter) => {
        const div = document.createElement("div");
        div.className = "card";
        const ar = document.createElement("div");
        ar.className = "card-ar";
        ar.textContent = letter.char;

        const name = document.createElement("div");
        name.className = "card-name";
        name.textContent = letter.name;

        const sound = document.createElement("div");
        sound.className = "card-sound";
        sound.textContent = letter.sound;

        div.appendChild(ar);
        div.appendChild(name);
        div.appendChild(sound);

        div.addEventListener("click", () => {
          document.querySelectorAll("#lettersList .card").forEach(c => c.classList.remove("active"));
          div.classList.add("active");
          currentSelection = {
            type: "ììŒ",
            arabic: letter.char,
            meaning: letter.name,
            pron: letter.sound,
            forms: letter.forms || null
          };
          renderSelectionInfo(currentSelection);
          updateTraceGuide(letter.char);
       // ì„ íƒ ì‹œ 1íšŒ ìë™ ì¬ìƒ
        });

        lettersList.appendChild(div);
      });
    }

    function initVowels() {
      vowelsList.innerHTML = "";
      vowels.forEach((v) => {
        const div = document.createElement("div");
        div.className = "card";
        const ar = document.createElement("div");
        ar.className = "card-ar";
        ar.textContent = v.char;

        const name = document.createElement("div");
        name.className = "card-name";
        name.textContent = v.name;

        const sound = document.createElement("div");
        sound.className = "card-sound";
        sound.textContent = v.sound;

        div.appendChild(ar);
        div.appendChild(name);
        div.appendChild(sound);

        div.addEventListener("click", () => {
          document.querySelectorAll("#vowelsList .card").forEach(c => c.classList.remove("active"));
          div.classList.add("active");
          currentSelection = {
            type: "ëª¨ìŒ",
            arabic: v.char,
            meaning: v.name,
            pron: v.sound,
            forms: null
          };
          renderSelectionInfo(currentSelection);
          updateTraceGuide(v.char);
        });

        vowelsList.appendChild(div);
      });
    }

    let currentWordCategory = "colors";

    function setWordCategory(cat) {
      currentWordCategory = cat;
      document.querySelectorAll("button[data-wordcat]").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.wordcat === cat);
      });
      renderWordList();
    }

    function renderWordList() {
      const list = wordCategories[currentWordCategory] || [];
      wordsList.innerHTML = "";
      list.forEach((w) => {
        const div = document.createElement("div");
        div.className = "card";
        const ar = document.createElement("div");
        ar.className = "card-ar";
        ar.textContent = w.arabic;

        const name = document.createElement("div");
        name.className = "card-name";
        name.textContent = w.meaning;

        const sound = document.createElement("div");
        sound.className = "card-sound";
        sound.textContent = w.pron;

        div.appendChild(ar);
        div.appendChild(name);
        div.appendChild(sound);

        div.addEventListener("click", () => {
          document.querySelectorAll("#wordsList .card").forEach(c => c.classList.remove("active"));
          div.classList.add("active");
          currentSelection = {
            type: "ë‹¨ì–´",
            arabic: w.arabic,
            meaning: w.meaning,
            pron: w.pron,
            forms: null
          };
          renderSelectionInfo(currentSelection);
          updateTraceGuide(w.arabic);
          speakArabic(w.arabic);
        });

        wordsList.appendChild(div);
      });
    }

    function initWordCategoryButtons() {
      document.querySelectorAll("button[data-wordcat]").forEach(btn => {
        btn.addEventListener("click", () => setWordCategory(btn.dataset.wordcat));
      });
      setWordCategory("colors");
    }

    function initSentences() {
      sentencesList.innerHTML = "";
      sentences.forEach((s, idx) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.style.padding = "6px 8px";
        btn.style.fontSize = "0.8rem";
        btn.style.borderRadius = "10px";
        btn.style.border = "1px solid #e5e7eb";
        btn.style.background = "white";
        btn.style.cursor = "pointer";
        btn.style.textAlign = "left";
        btn.textContent = (idx + 1) + ". " + s.meaning;

        btn.addEventListener("click", () => {
          document.querySelectorAll("#sentencesList button").forEach(b => {
            b.style.borderColor = "#e5e7eb";
            b.style.background = "white";
          });
          btn.style.borderColor = "#f97316";
          btn.style.background = "#fff7ed";
          currentSelection = {
            type: "ë¬¸ì¥",
            arabic: s.arabic,
            meaning: s.meaning,
            pron: s.pron,
            forms: null
          };
          renderSelectionInfo(currentSelection);
          updateTraceGuide(s.arabic);
          speakArabic(s.arabic);
        });

        sentencesList.appendChild(btn);
      });
    }

    // ======================
    // ì„ íƒ ì •ë³´ ì¹´ë“œ ë Œë”ë§
    // ======================
    function renderSelectionInfo(sel) {
      if (!sel) {
        selArabic.textContent = "ì•„ëì–´ ì—°ìŠµ ì‚¬ì´íŠ¸";
        selType.textContent = "ì•ˆë‚´";
        selExtra.innerHTML = "<span>ì™¼ìª½ì—ì„œ ììŒÂ·ëª¨ìŒÂ·ë‹¨ì–´Â·ë¬¸ì¥ì„ ì„ íƒí•˜ë©´ ì´ê³³ì— ì •ë³´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</span>";
        selForms.classList.add("hidden");
        playSelectionBtn.style.display = "inline-flex";
        return;
      }

      selArabic.textContent = sel.arabic;
      selType.textContent = sel.type;
      const extraParts = [];
      if (sel.meaning) {
        extraParts.push(`<span>ëœ»: ${sel.meaning}</span>`);
      }
      if (sel.pron) {
        extraParts.push(`<span>ë°œìŒ: ${sel.pron}</span>`);
      }
      selExtra.innerHTML = extraParts.join(" Â· ");

            if (sel.forms) {
        selForms.classList.remove("hidden");
        selForms.innerHTML = `
          <button type="button" class="selection-form-btn" onclick="selectFormVariant('isolated')">
            <span class="form-label">ë‹¨ë…í˜•</span>
            <span class="form-ar">${sel.forms.isolated}</span>
          </button>
          <button type="button" class="selection-form-btn" onclick="selectFormVariant('initial')">
            <span class="form-label">ì–´ë‘í˜•</span>
            <span class="form-ar">${sel.forms.initial}</span>
          </button>
          <button type="button" class="selection-form-btn" onclick="selectFormVariant('medial')">
            <span class="form-label">ì–´ì¤‘í˜•</span>
            <span class="form-ar">${sel.forms.medial}</span>
          </button>
          <button type="button" class="selection-form-btn" onclick="selectFormVariant('final')">
            <span class="form-label">ì–´ë§í˜•</span>
            <span class="form-ar">${sel.forms.final}</span>
          </button>
        `;
           } else {
        selForms.classList.add("hidden");
      }

      // ììŒ/ëª¨ìŒì´ë©´ ë°œìŒ ë²„íŠ¼ ìˆ¨ê¸°ê¸°, ê·¸ ì™¸(ë‹¨ì–´/ë¬¸ì¥)ëŠ” ë³´ì´ê¸°
      if (sel.type === "ììŒ" || sel.type === "ëª¨ìŒ") {
        playSelectionBtn.style.display = "none";
      } else {
        playSelectionBtn.style.display = "inline-flex";
      }

// === í˜•íƒœ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ===
setTimeout(() => {
  document.querySelectorAll(".form-btn").forEach(btn => {
    btn.onclick = () => {
      const formType = btn.dataset.form;
      if (!currentSelection || !currentSelection.arabic) return;

      const char = currentSelection.arabic;
      const forms = arabicForms[char];
      if (!forms) return;

      const selectedForm = forms[formType];
      updateTraceGuide(selectedForm);
    };
  });
}, 0);

    }

    // í˜•íƒœ ì„ íƒ ë²„íŠ¼ í´ë¦­
document.querySelectorAll(".form-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const formType = btn.dataset.form;
    if (!currentSelectedArabic) return;

    // í˜„ì¬ ì„ íƒëœ ììŒì˜ í•´ë‹¹ í˜•íƒœ ê°€ì ¸ì˜¤ê¸°
    const selectedForm =
      arabicForms[currentSelectedArabic] &&
      arabicForms[currentSelectedArabic][formType];

    if (selectedForm) {
      updateTraceGuide(selectedForm);
    }
  });
});


        function selectFormVariant(which) {
      if (!currentSelection || !currentSelection.forms) return;
      const formText = currentSelection.forms[which];
      if (!formText) return;

      // ì„ íƒí•œ í˜•íƒœë¡œ ë”°ë¼ì“°ê¸° ê°€ì´ë“œ ë³€ê²½
      updateTraceGuide(formText);

      // ì„ íƒí•œ í˜•íƒœ ë°œìŒë„ ë“£ê³  ì‹¶ìœ¼ë©´ ìœ ì§€
      speakArabic(formText);
    }


    // ======================
    // TTS (ë°œìŒ) - ì•„ëì–´ ë³´ì´ìŠ¤ ìš°ì„ 
    // ======================
    let availableVoices = [];
    function loadVoices() {
      availableVoices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
    }
    if (window.speechSynthesis) {
      loadVoices();
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    function speakArabic(text) {
      if (!window.speechSynthesis || !text) return;
      const utter = new SpeechSynthesisUtterance(text);

      // ì•„ëì–´ ë³´ì´ìŠ¤ ìš°ì„  ì„ íƒ
      let arVoices = availableVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith("ar"));
      if (arVoices.length > 0) {
        utter.voice = arVoices[0];
        utter.lang = arVoices[0].lang;
      } else {
        // í´ë°±: ì•„ëì–´ ì½”ë“œë§Œ ì§€ì • (ë¸Œë¼ìš°ì €ê°€ ì•Œì•„ì„œ ì„ íƒ)
        utter.lang = "ar-SA";
      }

      // ë§í•˜ê¸° ì†ë„/í†¤ íŠœë‹ (ì¡°ê¸ˆ ì²œì²œíˆ, ë˜ë ·í•˜ê²Œ)
      utter.rate = 0.9;
      utter.pitch = 1.0;

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

   playSelectionBtn.addEventListener("click", () => {
  if (!currentSelection || !currentSelection.arabic) return;

  // ììŒ/ëª¨ìŒì€ ë°œìŒ ì¬ìƒí•˜ì§€ ì•ŠìŒ
  if (currentSelection.type === "ììŒ" || currentSelection.type === "ëª¨ìŒ") return;

  speakArabic(currentSelection.arabic);
});


    // ======================
    // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ë° ê·¸ë¦¬ê¸°
    // ======================
    function resizeCanvas(canvas, ctx, keepGuide) {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.lineWidth = 4;
      ctx.strokeStyle = "#111827";

      if (keepGuide) {
        drawTraceGuide();
      }
    }

    function initCanvases() {
      traceCtx = traceCanvas.getContext("2d");
      freeCtx = freeCanvas.getContext("2d");
      resizeCanvas(traceCanvas, traceCtx, true);
      resizeCanvas(freeCanvas, freeCtx, false);

      // ë”°ë¼ì“°ê¸° ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸°
      initDrawing(traceCanvas, traceCtx, () => { traceDrawing = true; }, () => { traceDrawing = false; });
      // ì§ì ‘ ì“°ê¸° ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸°
      initDrawing(freeCanvas, freeCtx, () => { freeDrawing = true; }, () => { freeDrawing = false; });

      window.addEventListener("resize", () => {
        resizeCanvas(traceCanvas, traceCtx, true);
        resizeCanvas(freeCanvas, freeCtx, false);
      });
    }

    function initDrawing(canvas, ctx, onStart, onEnd) {
      let drawing = false;

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left);
        const y = (e.clientY - rect.top);
        return { x, y };
      }

      canvas.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        drawing = true;
        onStart();
        const { x, y } = getPos(e);
        ctx.beginPath();
        ctx.moveTo(x, y);
      });

      canvas.addEventListener("pointermove", (e) => {
        if (!drawing) return;
        e.preventDefault();
        const { x, y } = getPos(e);
        ctx.lineTo(x, y);
        ctx.stroke();
      });

      const stop = (e) => {
        if (!drawing) return;
        drawing = false;
        onEnd();
      };
      canvas.addEventListener("pointerup", stop);
      canvas.addEventListener("pointerleave", stop);
      window.addEventListener("pointerup", stop);
    }

    // ë”°ë¼ì“°ê¸° ê°€ì´ë“œ í…ìŠ¤íŠ¸
    // ë”°ë¼ì“°ê¸° ê°€ì´ë“œ í…ìŠ¤íŠ¸
function updateTraceGuide(text) {
  // 1) ìƒˆë¡œìš´ ê°€ì´ë“œ í…ìŠ¤íŠ¸ ì„¤ì •
  traceGuideText = text || "";

  // 2) ë”°ë¼ì“°ê¸° ìº”ë²„ìŠ¤ ì „ì²´ë¥¼ ì§€ìš°ê³ , ì—°í•œ ê¸€ìë¡œ ê°€ì´ë“œ ë‹¤ì‹œ ê·¸ë¦¼
  drawTraceGuide();

  // 3) ì§ì ‘ ì“°ê¸° ìº”ë²„ìŠ¤ë„ ê°™ì´ ì´ˆê¸°í™” (ì‚¬ìš©ìê°€ ì“´ ê¸€ì”¨ë§Œ ì§€ì›€)
  if (freeCtx && freeCanvas) {
    freeCtx.clearRect(0, 0, freeCanvas.width, freeCanvas.height);
  }
}


    function drawTraceGuide() {
      if (!traceCtx) return;
      const canvas = traceCanvas;
      traceCtx.clearRect(0, 0, canvas.width, canvas.height);
      if (!traceGuideText) return;

      const rect = canvas.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      traceCtx.save();
      traceCtx.globalAlpha = 0.12;
      traceCtx.fillStyle = "#9ca3af";
      traceCtx.textAlign = "center";
      traceCtx.textBaseline = "middle";
      const fontSize = Math.min(w, h) * 0.6;
      traceCtx.font = `${fontSize}px "Scheherazade New", "Noto Naskh Arabic", system-ui, sans-serif`;
      traceCtx.direction = "rtl";
      traceCtx.fillText(traceGuideText, w / 2, h / 2);
      traceCtx.restore();
    }

    // ì§€ìš°ê¸° ë²„íŠ¼: ìœ ì €ê°€ ê·¸ë¦° ë¶€ë¶„ë§Œ ì‚­ì œ, ê°€ì´ë“œëŠ” ë‹¤ì‹œ ê·¸ë¦¼
    clearBtn.addEventListener("click", () => {
      // ë”°ë¼ì“°ê¸° ìº”ë²„ìŠ¤: ì „ì²´ ì§€ìš°ê³  ê°€ì´ë“œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
      drawTraceGuide();
      // ì§ì ‘ ì“°ê¸° ìº”ë²„ìŠ¤: ì „ì²´ í´ë¦¬ì–´
      freeCtx.clearRect(0, 0, freeCanvas.width, freeCanvas.height);
    });

        // ======================
    // ë…¹ìŒ ê¸°ëŠ¥ (MediaRecorder)
    // ======================
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordedAudioUrl = null;
    let playbackAudio = null;

        function setRecordUi(state) {
      // state: 'idle' | 'recording' | 'ready'
      if (!recordStartBtn || !recordStopBtn || !recordPlayBtn || !recordStatus) return;

      if (state === "recording") {
        recordStartBtn.disabled = true;
        recordStopBtn.disabled = false;
        recordPlayBtn.disabled = true;
        // ì¬ìƒ ë²„íŠ¼ì€ ì•„ì§ ì‚¬ìš© ë¶ˆê°€ + ê¸°ë³¸ í…ìŠ¤íŠ¸ë¡œ ìœ ì§€
        recordPlayBtn.textContent = "â–¶ ì¬ìƒ";
        recordStatus.textContent = "ë…¹ìŒ ì¤‘â€¦ ì½ê³  ì‹¶ì€ ë¬¸ì¥ì„ ë§í•´ ë³´ì„¸ìš”.";
      } else if (state === "ready") {
        recordStartBtn.disabled = false;
        recordStopBtn.disabled = true;
        recordPlayBtn.disabled = false;
        // ë…¹ìŒì€ ëë‚¬ê³ , ì¬ìƒ ëŒ€ê¸° ìƒíƒœì´ë¯€ë¡œ â–¶ ì¬ìƒìœ¼ë¡œ ëŒë ¤ë‘ê¸°
        recordPlayBtn.textContent = "â–¶ ì¬ìƒ";
        recordStatus.textContent = "ë…¹ìŒ ì™„ë£Œ! ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë“¤ì–´ë³´ì„¸ìš”.";
      } else {
        // idle
        recordStartBtn.disabled = false;
        recordStopBtn.disabled = true;
        recordPlayBtn.disabled = true;
        recordPlayBtn.textContent = "â–¶ ì¬ìƒ";
        recordStatus.textContent = "ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.";
      }
    }


    async function startRecording() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ë…¹ìŒ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            recordedChunks.push(e.data);
          }
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "audio/webm" });
          if (recordedAudioUrl) {
            URL.revokeObjectURL(recordedAudioUrl);
          }
          recordedAudioUrl = URL.createObjectURL(blob);
          setRecordUi("ready");
        };

        mediaRecorder.start();
        setRecordUi("recording");
      } catch (err) {
        console.error(err);
        alert("ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.");
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    }

            function playRecording() {
      if (!recordedAudioUrl) return;

      // ì´ë¯¸ ì¬ìƒ ì¤‘ì´ë©´ â†’ ë©ˆì¶”ê³ , ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ "â–¶ ì¬ìƒ"ìœ¼ë¡œ
      if (playbackAudio) {
        playbackAudio.pause();
        playbackAudio.currentTime = 0;
        playbackAudio = null;
        recordPlayBtn.textContent = "â–¶ ì¬ìƒ";
        recordStatus.textContent = "ì¬ìƒì„ ë©ˆì·„ìŠµë‹ˆë‹¤.";
        return;
      }

      // ìƒˆë¡œ ì¬ìƒ ì‹œì‘
      playbackAudio = new Audio(recordedAudioUrl);
      playbackAudio.onended = () => {
        playbackAudio = null;
        // ì¬ìƒì´ ìì—°ìŠ¤ëŸ½ê²Œ ëë‚¬ì„ ë•Œë„ ë²„íŠ¼ì„ ë‹¤ì‹œ â–¶ ì¬ìƒìœ¼ë¡œ
        recordPlayBtn.textContent = "â–¶ ì¬ìƒ";
        recordStatus.textContent = "ì¬ìƒì´ ëë‚¬ìŠµë‹ˆë‹¤.";
      };

      playbackAudio.play();
      // ì¬ìƒ ì‹œì‘ ì‹œ ë²„íŠ¼ì„ â¹ ë©ˆì¶¤ìœ¼ë¡œ ë³€ê²½
      recordPlayBtn.textContent = "â¹ ë©ˆì¶¤";
      recordStatus.textContent = "ë…¹ìŒëœ ì†Œë¦¬ë¥¼ ì¬ìƒ ì¤‘ì…ë‹ˆë‹¤.";
    }



    // ë…¹ìŒ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    if (recordStartBtn && recordStopBtn && recordPlayBtn) {
      setRecordUi("idle");
      recordStartBtn.addEventListener("click", startRecording);
      recordStopBtn.addEventListener("click", stopRecording);
      recordPlayBtn.addEventListener("click", playRecording);
    }

    
    // ======================
    // ì´ˆê¸° ì‹¤í–‰
    // ======================
    initLetters();
    initVowels();
    initWordCategoryButtons();
    renderWordList();
    initSentences();
    initCanvases();
    renderSelectionInfo(null);
  </script>
</body>
</html>
